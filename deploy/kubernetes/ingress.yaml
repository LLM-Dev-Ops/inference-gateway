# LLM Inference Gateway Ingress
# Configures external access to the gateway

# NGINX Ingress Controller configuration
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: llm-gateway-ingress
  namespace: llm-gateway
  labels:
    app.kubernetes.io/name: llm-inference-gateway
    app.kubernetes.io/component: ingress
  annotations:
    # NGINX Ingress Controller annotations
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "60"

    # Enable WebSocket support for streaming
    nginx.ingress.kubernetes.io/proxy-http-version: "1.1"
    nginx.ingress.kubernetes.io/upstream-hash-by: "$remote_addr"

    # Rate limiting at ingress level
    nginx.ingress.kubernetes.io/limit-rps: "100"
    nginx.ingress.kubernetes.io/limit-connections: "50"

    # SSL/TLS configuration
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"

    # CORS configuration (adjust origins as needed)
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,X-API-Key"

    # Security headers
    nginx.ingress.kubernetes.io/configuration-snippet: |
      more_set_headers "X-Content-Type-Options: nosniff";
      more_set_headers "X-Frame-Options: DENY";
      more_set_headers "X-XSS-Protection: 1; mode=block";
      more_set_headers "Referrer-Policy: strict-origin-when-cross-origin";

    # cert-manager for automatic TLS (if using cert-manager)
    # cert-manager.io/cluster-issuer: "letsencrypt-prod"
spec:
  ingressClassName: nginx

  # TLS configuration
  tls:
    - hosts:
        - llm-gateway.example.com
      secretName: llm-gateway-tls

  rules:
    - host: llm-gateway.example.com
      http:
        paths:
          # API endpoints
          - path: /v1
            pathType: Prefix
            backend:
              service:
                name: llm-gateway
                port:
                  name: http

          # Health endpoints (for load balancer health checks)
          - path: /health
            pathType: Exact
            backend:
              service:
                name: llm-gateway
                port:
                  name: http

          - path: /ready
            pathType: Exact
            backend:
              service:
                name: llm-gateway
                port:
                  name: http

          - path: /live
            pathType: Exact
            backend:
              service:
                name: llm-gateway
                port:
                  name: http

---
# Separate ingress for admin endpoints (with stricter access controls)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: llm-gateway-admin-ingress
  namespace: llm-gateway
  labels:
    app.kubernetes.io/name: llm-inference-gateway
    app.kubernetes.io/component: ingress
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "true"

    # Whitelist admin access to specific IPs
    nginx.ingress.kubernetes.io/whitelist-source-range: "10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"

    # Basic auth for admin endpoints (create secret first)
    # nginx.ingress.kubernetes.io/auth-type: basic
    # nginx.ingress.kubernetes.io/auth-secret: llm-gateway-admin-auth
    # nginx.ingress.kubernetes.io/auth-realm: "LLM Gateway Admin"
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - llm-gateway-admin.example.com
      secretName: llm-gateway-admin-tls
  rules:
    - host: llm-gateway-admin.example.com
      http:
        paths:
          - path: /admin
            pathType: Prefix
            backend:
              service:
                name: llm-gateway
                port:
                  name: http

          - path: /metrics
            pathType: Exact
            backend:
              service:
                name: llm-gateway
                port:
                  name: metrics

---
# AWS ALB Ingress (alternative for AWS deployments)
# Uncomment if using AWS Application Load Balancer
#
# apiVersion: networking.k8s.io/v1
# kind: Ingress
# metadata:
#   name: llm-gateway-alb-ingress
#   namespace: llm-gateway
#   labels:
#     app.kubernetes.io/name: llm-inference-gateway
#     app.kubernetes.io/component: ingress
#   annotations:
#     kubernetes.io/ingress.class: alb
#     alb.ingress.kubernetes.io/scheme: internet-facing
#     alb.ingress.kubernetes.io/target-type: ip
#     alb.ingress.kubernetes.io/listen-ports: '[{"HTTPS":443}]'
#     alb.ingress.kubernetes.io/ssl-redirect: '443'
#     alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:region:account:certificate/cert-id
#     alb.ingress.kubernetes.io/healthcheck-path: /health
#     alb.ingress.kubernetes.io/healthcheck-interval-seconds: '30'
#     alb.ingress.kubernetes.io/healthcheck-timeout-seconds: '5'
#     alb.ingress.kubernetes.io/healthy-threshold-count: '2'
#     alb.ingress.kubernetes.io/unhealthy-threshold-count: '3'
# spec:
#   ingressClassName: alb
#   rules:
#     - host: llm-gateway.example.com
#       http:
#         paths:
#           - path: /
#             pathType: Prefix
#             backend:
#               service:
#                 name: llm-gateway
#                 port:
#                   name: http

---
# GCP GKE Ingress (alternative for GCP deployments)
# Uncomment if using Google Cloud Load Balancer
#
# apiVersion: networking.k8s.io/v1
# kind: Ingress
# metadata:
#   name: llm-gateway-gke-ingress
#   namespace: llm-gateway
#   labels:
#     app.kubernetes.io/name: llm-inference-gateway
#     app.kubernetes.io/component: ingress
#   annotations:
#     kubernetes.io/ingress.class: gce
#     kubernetes.io/ingress.global-static-ip-name: llm-gateway-ip
#     networking.gke.io/managed-certificates: llm-gateway-cert
#     kubernetes.io/ingress.allow-http: "false"
# spec:
#   rules:
#     - host: llm-gateway.example.com
#       http:
#         paths:
#           - path: /*
#             pathType: ImplementationSpecific
#             backend:
#               service:
#                 name: llm-gateway
#                 port:
#                   name: http

